@model GraciaDivina.Models.ViewModels.AdminProductVM
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Editar producto";
}

@if (TempData["ok"] is string ok && !string.IsNullOrWhiteSpace(ok))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @ok
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @err
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<h1 class="h4 mb-3">Editar producto</h1>

<!-- ====== FORMULARIO PRINCIPAL (PRODUCTO + VARIANTES) ====== -->
<form asp-area="Admin"
      asp-controller="Productos"
      asp-action="Guardar"
      method="post"
      enctype="multipart/form-data"
      class="row g-3">

    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="ProductoID" />
    <input type="hidden" asp-for="ImagenUrl" />

    <!-- Datos básicos -->
    <div class="col-12 col-md-8">
        <label asp-for="Nombre" class="form-label"></label>
        <input asp-for="Nombre" class="form-control" />
        <span class="text-danger" asp-validation-for="Nombre"></span>
    </div>

    <div class="col-12 col-md-4">
        <label asp-for="Precio" class="form-label"></label>
        <input asp-for="Precio" type="number" step="0.01" class="form-control" />
        <span class="text-danger" asp-validation-for="Precio"></span>
    </div>

    <div class="col-12">
        <label asp-for="Descripcion" class="form-label"></label>
        <textarea asp-for="Descripcion" rows="4" class="form-control"></textarea>
        <span class="text-danger" asp-validation-for="Descripcion"></span>
    </div>

    <div class="col-12 col-md-6">
        <label asp-for="CategoriaID" class="form-label">Categoría</label>
        <select asp-for="CategoriaID" class="form-select" asp-items="ViewBag.Categorias">
            <option value="">(Sin categoría)</option>
        </select>
        <span class="text-danger" asp-validation-for="CategoriaID"></span>
    </div>

    <div class="col-12 col-md-6 d-flex align-items-end">
        <div class="form-check">
            <input asp-for="Activo" class="form-check-input" type="checkbox" />
            <label asp-for="Activo" class="form-check-label"></label>
        </div>
    </div>

    <div class="col-12 col-md-6">
        <label class="form-label">Imagen principal (opcional)</label>
        <input asp-for="Imagen" type="file" class="form-control" accept="image/*" />
        <small class="text-muted">Si no eliges archivo, se conservará la imagen actual.</small>

        @if (!string.IsNullOrWhiteSpace(Model?.ImagenUrl))
        {
            <div class="mt-2">
                <img src="@Model.ImagenUrl" alt="Imagen actual"
                     style="max-height:120px;border:1px solid #ddd;border-radius:6px;padding:2px;">
            </div>
        }
    </div>

    <hr class="my-4" />

    <!-- ===== Variantes iniciales ===== -->
    <h6 class="mb-2">Variantes iniciales (opcional)</h6>
    <p class="text-muted mb-2">
        Marca tallas y, si deseas, define color/stock/sku base. Al guardar, se crearán nuevas variantes.
        Si no marcas tallas, <strong>no se hará ningún cambio</strong>.
    </p>

    <div class="mb-2">
        <strong>Tallas disponibles</strong>

        <div class="d-flex gap-2 my-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMarcarTallas">Marcar todas</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnQuitarTallas">Quitar todas</button>
        </div>

        @{
            var marcadas = (IEnumerable<int>)(ViewBag.TallasMarcadas ?? Enumerable.Empty<int>());
        }

        <div class="row row-cols-2 row-cols-md-4 g-1">
            @foreach (SelectListItem t in (IEnumerable<SelectListItem>)ViewBag.Tallas)
            {
                var isChecked = int.TryParse(t.Value, out var tid) && marcadas.Contains(tid);
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="tallas"
                               value="@t.Value"
                               id="talla_@t.Value"
                               @(isChecked ? "checked" : null)>
                        <label class="form-check-label" for="talla_@t.Value">@t.Text</label>
                    </div>
                </div>
            }
        </div>
        <small class="text-muted d-block mt-1">
            Desmarca una talla para eliminar sus variantes actuales; marca nuevas tallas para crearlas.
        </small>
    </div>

    <div class="row g-3">
        <div class="col-12 col-md-4">
            <label class="form-label">Color (opcional, texto libre)</label>
            <input name="colorNombre" class="form-control" placeholder="Ej.: Negro, Azul Marino">
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">SKU base (opcional)</label>
            <input name="sku" class="form-control" placeholder="Si lo dejas vacío, el sistema genera">
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">Stock inicial (opcional)</label>
            <input name="stock" type="number" min="0" class="form-control" value="0">
        </div>
    </div>

    <div class="col-12 mt-3">
        <button class="btn btn-primary" type="submit">Guardar</button>
        <a asp-area="Admin" asp-controller="Productos" asp-action="Index"
           class="btn btn-outline-secondary">Volver</a>
    </div>
</form>

<!-- ====== GALERÍA DE IMÁGENES (FUERA DEL FORM PRINCIPAL) ====== -->
<h5 class="mt-4 mb-3">Galería de imágenes</h5>

<form asp-area="Admin"
      asp-controller="Productos"
      asp-action="SubirImagen"
      method="post"
      enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" name="productoId" value="@Model.ProductoID" />
    <div class="input-group mb-3">
        <input type="file" name="imagen" class="form-control" accept="image/*" />
        <button class="btn btn-primary" type="submit">Subir</button>
    </div>
</form>

<div id="galeria-imagenes" class="mb-4">
    @await Html.PartialAsync("_ProductoImagenes", ViewBag.Imagenes as IEnumerable<GraciaDivina.Models.ProductoImagen>)
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.getElementById('btnMarcarTallas')?.addEventListener('click', () => {
            document.querySelectorAll('input[name="tallas"]').forEach(cb => cb.checked = true);
        });
        document.getElementById('btnQuitarTallas')?.addEventListener('click', () => {
            document.querySelectorAll('input[name="tallas"]').forEach(cb => cb.checked = false);
        });
    </script>
}
